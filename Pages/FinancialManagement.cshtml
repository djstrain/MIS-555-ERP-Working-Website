@page
@model FinancialManagementModel
@{
    ViewData["Title"] = "Financial Management";
}

<div class="container py-3">
    <h2 class="mb-4">Financial Management Dashboard</h2>

    <!-- Display Messages -->
    @if (!string.IsNullOrEmpty(Model.Message))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle"></i> @Model.Message
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle"></i> @Model.ErrorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- Aggregate Metrics Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card border-primary shadow-sm">
                <div class="card-body text-center">
                    <h6 class="card-title text-muted mb-1">Total Revenue</h6>
                    <h3 class="text-primary mb-0">@Model.TotalRevenue.ToString("C")</h3>
                    <small class="text-muted">@Model.Invoices.Count invoices</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-danger shadow-sm">
                <div class="card-body text-center">
                    <h6 class="card-title text-muted mb-1">Total Expenses</h6>
                    <h3 class="text-danger mb-0">@Model.TotalExpenses.ToString("C")</h3>
                    <small class="text-muted">@Model.Accounts.Count(a => a.AccountType == "Expense") accounts</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-success shadow-sm">
                <div class="card-body text-center">
                    <h6 class="card-title text-muted mb-1">Net Balance</h6>
                    <h3 class="text-success mb-0">@Model.NetBalance.ToString("C")</h3>
                    <small class="text-muted">@Model.PaidInvoices paid</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Toolbar -->
    <div class="mb-3 d-flex flex-wrap gap-2">
        <button type="button" class="btn btn-outline-primary" data-category="accounts">Accounts</button>
        <button type="button" class="btn btn-outline-primary" data-category="partners">Partners</button>
        <button type="button" class="btn btn-outline-primary" data-category="invoices">Invoices</button>
        <button type="button" class="btn btn-outline-primary" data-category="openbalances">Open Balances</button>
        <button type="button" class="btn btn-outline-primary" data-category="payments">Payments</button>
        <button type="button" class="btn btn-outline-primary" data-category="journalentries">Journal Entries</button>
        <button type="button" class="btn btn-outline-primary" data-category="invoicelines">Invoice Lines</button>
        <button type="button" class="btn btn-outline-primary" data-category="journallines">Journal Lines</button>
        <button type="button" class="btn btn-outline-primary" data-category="taxrates">Tax Rates</button>
    </div>

    <!-- ========== ACCOUNTS MODULE ========== -->
    <div class="card mb-3 financial-module" id="module-accounts">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Accounts</h5>
            <button class="btn btn-sm btn-secondary toggle-btn" data-bs-toggle="collapse" data-bs-target="#accountsCollapse" aria-expanded="false">Toggle</button>
        </div>
        <div id="accountsCollapse" class="collapse" data-category-collapse="accounts">
            <div class="card-body">
                <form method="post" class="row g-2 mb-3" asp-antiforgery="true">
                    <input type="hidden" asp-for="ActiveCategory" />
                    <input type="hidden" asp-for="FormType" value="account" />
                    <div class="col-md-3">
                        <input asp-for="NewAccountNumber" class="form-control" placeholder="Account Number" required />
                    </div>
                    <div class="col-md-3">
                        <input asp-for="NewAccountName" class="form-control" placeholder="Account Name" required />
                    </div>
                    <div class="col-md-2">
                        <select asp-for="NewAccountType" class="form-select" required>
                            <option value="">Type</option>
                            <option value="Asset">Asset</option>
                            <option value="Liability">Liability</option>
                            <option value="Equity">Equity</option>
                            <option value="Revenue">Revenue</option>
                            <option value="Expense">Expense</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <input asp-for="NewAccountBalance" type="number" class="form-control" placeholder="Balance" step="0.01" />
                    </div>
                    <div class="col-md-2 d-grid">
                        <button type="submit" class="btn btn-primary">Add</button>
                    </div>
                </form>
                <div class="table-responsive">
                    <table class="table table-sm table-striped mb-0">
                        <thead>
                            <tr><th>Number</th><th>Name</th><th>Type</th><th>Balance</th><th>Created</th></tr>
                        </thead>
                        <tbody>
                            @foreach (var a in Model.Accounts)
                            {
                                <tr>
                                    <td>@a.AccountNumber</td>
                                    <td>@a.AccountName</td>
                                    <td>@a.AccountType</td>
                                    <td>@a.Balance.ToString("C")</td>
                                    <td>@a.CreatedAt.ToLocalTime().ToString("MM/dd/yyyy")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== PARTNERS MODULE ========== -->
    <div class="card mb-3 financial-module" id="module-partners">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Partners</h5>
            <button class="btn btn-sm btn-secondary toggle-btn" data-bs-toggle="collapse" data-bs-target="#partnersCollapse" aria-expanded="false">Toggle</button>
        </div>
        <div id="partnersCollapse" class="collapse" data-category-collapse="partners">
            <div class="card-body">
                <form method="post" class="row g-2 mb-3" asp-antiforgery="true">
                    <input type="hidden" asp-for="ActiveCategory" />
                    <input type="hidden" asp-for="FormType" value="partner" />
                    <div class="col-md-3">
                        <input asp-for="NewPartnerName" class="form-control" placeholder="Partner Name" required />
                    </div>
                    <div class="col-md-2">
                        <select asp-for="NewPartnerType" class="form-select" required>
                            <option value="">Type</option>
                            <option value="Vendor">Vendor</option>
                            <option value="Customer">Customer</option>
                            <option value="Supplier">Supplier</option>
                            <option value="Associate">Associate</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input asp-for="NewPartnerEmail" type="email" class="form-control" placeholder="Email" />
                    </div>
                    <div class="col-md-2">
                        <input asp-for="NewPartnerPhone" class="form-control" placeholder="Phone" />
                    </div>
                    <div class="col-md-2 d-grid">
                        <button type="submit" class="btn btn-primary">Add</button>
                    </div>
                </form>
                <div class="table-responsive">
                    <table class="table table-sm table-striped mb-0">
                        <thead>
                            <tr><th>Name</th><th>Type</th><th>Email</th><th>Phone</th><th>Created</th></tr>
                        </thead>
                        <tbody>
                            @foreach (var p in Model.Partners)
                            {
                                <tr>
                                    <td>@p.PartnerName</td>
                                    <td>@p.PartnerType</td>
                                    <td>@(string.IsNullOrWhiteSpace(p.Email) ? "-" : p.Email)</td>
                                    <td>@(string.IsNullOrWhiteSpace(p.Phone) ? "-" : p.Phone)</td>
                                    <td>@p.CreatedAt.ToLocalTime().ToString("MM/dd/yyyy")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== INVOICES MODULE ========== -->
    <div class="card mb-3 financial-module" id="module-invoices">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Invoices</h5>
            <button class="btn btn-sm btn-secondary toggle-btn" data-bs-toggle="collapse" data-bs-target="#invoicesCollapse" aria-expanded="false">Toggle</button>
        </div>
        <div id="invoicesCollapse" class="collapse" data-category-collapse="invoices">
            <div class="card-body">
                <form method="post" class="row g-2 mb-3" asp-antiforgery="true">
                    <input type="hidden" asp-for="ActiveCategory" />
                    <input type="hidden" asp-for="FormType" value="invoice" />
                    <div class="col-md-2">
                        <select asp-for="NewInvoicePartnerId" class="form-select" required>
                            <option value="0">Partner</option>
                            @foreach (var p in Model.Partners)
                            {
                                <option value="@p.Id">@p.PartnerName</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <input asp-for="NewInvoiceNumber" class="form-control" placeholder="Invoice #" required />
                    </div>
                    <div class="col-md-2">
                        <input asp-for="NewInvoiceAmount" type="number" class="form-control" placeholder="Amount" step="0.01" required />
                    </div>
                    <div class="col-md-2">
                        <input asp-for="NewInvoiceDate" type="date" class="form-control" />
                    </div>
                    <div class="col-md-2">
                        <input asp-for="NewInvoiceDueDate" type="date" class="form-control" />
                    </div>
                    <div class="col-md-1">
                        <select asp-for="NewInvoiceStatus" class="form-select">
                            <option value="Pending">Pending</option>
                            <option value="Paid">Paid</option>
                            <option value="Overdue">Overdue</option>
                        </select>
                    </div>
                    <div class="col-md-1 d-grid">
                        <button type="submit" class="btn btn-primary">Add</button>
                    </div>
                </form>
                <div class="table-responsive">
                    <table class="table table-sm table-striped mb-0">
                        <thead>
                            <tr><th>Invoice #</th><th>Partner</th><th>Amount</th><th>Status</th><th>Invoice Date</th><th>Due Date</th></tr>
                        </thead>
                        <tbody>
                            @foreach (var i in Model.Invoices)
                            {
                                var partner = Model.Partners.FirstOrDefault(p => p.Id == i.PartnerId);
                                <tr>
                                    <td>@i.InvoiceNumber</td>
                                    <td>@(partner?.PartnerName ?? "-")</td>
                                    <td>@i.Amount.ToString("C")</td>
                                    <td>@i.Status</td>
                                    <td>@i.InvoiceDate.ToLocalTime().ToString("MM/dd/yyyy")</td>
                                    <td>@i.DueDate.ToLocalTime().ToString("MM/dd/yyyy")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== OPEN BALANCES MODULE ========== -->
    <div class="card mb-3 financial-module" id="module-openbalances">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Open Balances</h5>
            <button class="btn btn-sm btn-secondary toggle-btn" data-bs-toggle="collapse" data-bs-target="#openbalancesCollapse" aria-expanded="false">Toggle</button>
        </div>
        <div id="openbalancesCollapse" class="collapse" data-category-collapse="openbalances">
            <div class="card-body">
                <form method="post" class="row g-2 mb-3" asp-antiforgery="true">
                    <input type="hidden" asp-for="ActiveCategory" />
                    <input type="hidden" asp-for="FormType" value="openbalance" />
                    <div class="col-md-4">
                        <select asp-for="NewOpenBalanceAccountId" class="form-select" required>
                            <option value="0">Account</option>
                            @foreach (var a in Model.Accounts)
                            {
                                <option value="@a.Id">@a.AccountNumber - @a.AccountName</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <input asp-for="NewOpenBalanceAmount" type="number" class="form-control" placeholder="Amount" step="0.01" required />
                    </div>
                    <div class="col-md-2">
                        <input asp-for="NewOpenBalanceDate" type="date" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <input asp-for="NewOpenBalanceDescription" class="form-control" placeholder="Description" />
                    </div>
                    <div class="col-md-1 d-grid">
                        <button type="submit" class="btn btn-primary">Add</button>
                    </div>
                </form>
                <div class="table-responsive">
                    <table class="table table-sm table-striped mb-0">
                        <thead>
                            <tr><th>Account</th><th>Balance</th><th>Date</th><th>Description</th></tr>
                        </thead>
                        <tbody>
                            @foreach (var ob in Model.OpenBalances)
                            {
                                var account = Model.Accounts.FirstOrDefault(a => a.Id == ob.AccountId);
                                <tr>
                                    <td>@(account != null ? $"{account.AccountNumber} - {account.AccountName}" : "-")</td>
                                    <td>@ob.OpeningBalance.ToString("C")</td>
                                    <td>@ob.BalanceDate.ToLocalTime().ToString("MM/dd/yyyy")</td>
                                    <td>@(string.IsNullOrWhiteSpace(ob.Description) ? "-" : ob.Description)</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== PAYMENTS MODULE ========== -->
    <div class="card mb-3 financial-module" id="module-payments">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Payments</h5>
            <button class="btn btn-sm btn-secondary toggle-btn" data-bs-toggle="collapse" data-bs-target="#paymentsCollapse" aria-expanded="false">Toggle</button>
        </div>
        <div id="paymentsCollapse" class="collapse" data-category-collapse="payments">
            <div class="card-body">
                <form method="post" class="row g-2 mb-3" asp-antiforgery="true">
                    <input type="hidden" asp-for="ActiveCategory" />
                    <input type="hidden" asp-for="FormType" value="payment" />
                    <div class="col-md-2">
                        <input asp-for="NewPaymentNumber" class="form-control" placeholder="Payment #" required />
                    </div>
                    <div class="col-md-3">
                        <select asp-for="NewPaymentInvoiceId" class="form-select" required>
                            <option value="0">Invoice</option>
                            @foreach (var i in Model.Invoices)
                            {
                                <option value="@i.Id">@i.InvoiceNumber (@i.Amount.ToString("C"))</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <input asp-for="NewPaymentAmount" type="number" class="form-control" placeholder="Amount" step="0.01" required />
                    </div>
                    <div class="col-md-2">
                        <input asp-for="NewPaymentDate" type="date" class="form-control" />
                    </div>
                    <div class="col-md-2">
                        <select asp-for="NewPaymentMethod" class="form-select">
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Check">Check</option>
                            <option value="Wire">Wire</option>
                            <option value="Credit Card">Credit Card</option>
                            <option value="Cash">Cash</option>
                        </select>
                    </div>
                    <div class="col-md-1 d-grid">
                        <button type="submit" class="btn btn-primary">Add</button>
                    </div>
                </form>
                <div class="table-responsive">
                    <table class="table table-sm table-striped mb-0">
                        <thead>
                            <tr><th>Payment #</th><th>Invoice</th><th>Amount</th><th>Date</th><th>Method</th></tr>
                        </thead>
                        <tbody>
                            @foreach (var pay in Model.Payments)
                            {
                                var invoice = Model.Invoices.FirstOrDefault(i => i.Id == pay.InvoiceId);
                                <tr>
                                    <td>@pay.PaymentNumber</td>
                                    <td>@(invoice?.InvoiceNumber ?? "-")</td>
                                    <td>@pay.PaymentAmount.ToString("C")</td>
                                    <td>@pay.PaymentDate.ToLocalTime().ToString("MM/dd/yyyy")</td>
                                    <td>@pay.PaymentMethod</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== JOURNAL ENTRIES MODULE ========== -->
    <div class="card mb-3 financial-module" id="module-journalentries">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Journal Entries</h5>
            <button class="btn btn-sm btn-secondary toggle-btn" data-bs-toggle="collapse" data-bs-target="#journalentriesCollapse" aria-expanded="false">Toggle</button>
        </div>
        <div id="journalentriesCollapse" class="collapse" data-category-collapse="journalentries">
            <div class="card-body">
                <form method="post" class="row g-2 mb-3" asp-antiforgery="true">
                    <input type="hidden" asp-for="ActiveCategory" />
                    <input type="hidden" asp-for="FormType" value="journalentry" />
                    <div class="col-md-2">
                        <input asp-for="NewJournalNumber" class="form-control" placeholder="Journal #" required />
                    </div>
                    <div class="col-md-3">
                        <select asp-for="NewJournalDebitAccountId" class="form-select" required>
                            <option value="0">Debit Account</option>
                            @foreach (var a in Model.Accounts)
                            {
                                <option value="@a.Id">@a.AccountNumber - @a.AccountName</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select asp-for="NewJournalCreditAccountId" class="form-select" required>
                            <option value="0">Credit Account</option>
                            @foreach (var a in Model.Accounts)
                            {
                                <option value="@a.Id">@a.AccountNumber - @a.AccountName</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <input asp-for="NewJournalAmount" type="number" class="form-control" placeholder="Amount" step="0.01" required />
                    </div>
                    <div class="col-md-1">
                        <input asp-for="NewJournalDate" type="date" class="form-control" />
                    </div>
                    <div class="col-md-1 d-grid">
                        <button type="submit" class="btn btn-primary">Add</button>
                    </div>
                    <div class="col-md-12">
                        <input asp-for="NewJournalDescription" class="form-control" placeholder="Description" />
                    </div>
                </form>
                <div class="table-responsive">
                    <table class="table table-sm table-striped mb-0">
                        <thead>
                            <tr><th>Journal #</th><th>Debit Acct</th><th>Credit Acct</th><th>Amount</th><th>Date</th><th>Description</th></tr>
                        </thead>
                        <tbody>
                            @foreach (var je in Model.JournalEntries)
                            {
                                var debit = Model.Accounts.FirstOrDefault(a => a.Id == je.DebitAccountId);
                                var credit = Model.Accounts.FirstOrDefault(a => a.Id == je.CreditAccountId);
                                <tr>
                                    <td>@je.JournalNumber</td>
                                    <td>@(debit != null ? $"{debit.AccountNumber}" : "-")</td>
                                    <td>@(credit != null ? $"{credit.AccountNumber}" : "-")</td>
                                    <td>@je.Amount.ToString("C")</td>
                                    <td>@je.EntryDate.ToLocalTime().ToString("MM/dd/yyyy")</td>
                                    <td title="@je.Description">@(string.IsNullOrWhiteSpace(je.Description) ? "-" : (je.Description.Length > 30 ? je.Description.Substring(0,30) + "..." : je.Description))</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== INVOICE LINES MODULE ========== -->
    <div class="card mb-3 financial-module" id="module-invoicelines">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Invoice Lines</h5>
            <button class="btn btn-sm btn-secondary toggle-btn" data-bs-toggle="collapse" data-bs-target="#invoicelinesCollapse" aria-expanded="false">Toggle</button>
        </div>
        <div id="invoicelinesCollapse" class="collapse" data-category-collapse="invoicelines">
            <div class="card-body">
                <form method="post" class="row g-2 mb-3" asp-antiforgery="true">
                    <input type="hidden" asp-for="ActiveCategory" />
                    <input type="hidden" asp-for="FormType" value="invoiceline" />
                    <div class="col-md-3">
                        <select asp-for="NewInvoiceLineInvoiceId" class="form-select" required>
                            <option value="0">Invoice</option>
                            @foreach (var i in Model.Invoices)
                            {
                                <option value="@i.Id">@i.InvoiceNumber</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input asp-for="NewInvoiceLineDescription" class="form-control" placeholder="Description" required />
                    </div>
                    <div class="col-md-2">
                        <input asp-for="NewInvoiceLineQuantity" type="number" class="form-control" placeholder="Qty" required />
                    </div>
                    <div class="col-md-2">
                        <input asp-for="NewInvoiceLineUnitPrice" type="number" class="form-control" placeholder="Unit Price" step="0.01" required />
                    </div>
                    <div class="col-md-2 d-grid">
                        <button type="submit" class="btn btn-primary">Add</button>
                    </div>
                </form>
                <div class="table-responsive">
                    <table class="table table-sm table-striped mb-0">
                        <thead>
                            <tr><th>Invoice</th><th>Description</th><th>Qty</th><th>Unit Price</th><th>Total</th></tr>
                        </thead>
                        <tbody>
                            @foreach (var il in Model.InvoiceLines)
                            {
                                var invoice = Model.Invoices.FirstOrDefault(i => i.Id == il.InvoiceId);
                                <tr>
                                    <td>@(invoice?.InvoiceNumber ?? "-")</td>
                                    <td>@il.Description</td>
                                    <td>@il.Quantity</td>
                                    <td>@il.UnitPrice.ToString("C")</td>
                                    <td>@il.LineTotal.ToString("C")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== JOURNAL LINES MODULE ========== -->
    <div class="card mb-3 financial-module" id="module-journallines">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Journal Lines</h5>
            <button class="btn btn-sm btn-secondary toggle-btn" data-bs-toggle="collapse" data-bs-target="#journallinesCollapse" aria-expanded="false">Toggle</button>
        </div>
        <div id="journallinesCollapse" class="collapse" data-category-collapse="journallines">
            <div class="card-body">
                <form method="post" class="row g-2 mb-3" asp-antiforgery="true">
                    <input type="hidden" asp-for="ActiveCategory" />
                    <input type="hidden" asp-for="FormType" value="journalline" />
                    <div class="col-md-3">
                        <select asp-for="NewJournalLineEntryId" class="form-select" required>
                            <option value="0">Journal Entry</option>
                            @foreach (var je in Model.JournalEntries)
                            {
                                <option value="@je.Id">@je.JournalNumber</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select asp-for="NewJournalLineAccountId" class="form-select" required>
                            <option value="0">Account</option>
                            @foreach (var a in Model.Accounts)
                            {
                                <option value="@a.Id">@a.AccountNumber - @a.AccountName</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <input asp-for="NewJournalLineDebit" type="number" class="form-control" placeholder="Debit" step="0.01" />
                    </div>
                    <div class="col-md-2">
                        <input asp-for="NewJournalLineCredit" type="number" class="form-control" placeholder="Credit" step="0.01" />
                    </div>
                    <div class="col-md-2 d-grid">
                        <button type="submit" class="btn btn-primary">Add</button>
                    </div>
                    <div class="col-md-12">
                        <input asp-for="NewJournalLineDescription" class="form-control" placeholder="Description" />
                    </div>
                </form>
                <div class="table-responsive">
                    <table class="table table-sm table-striped mb-0">
                        <thead>
                            <tr><th>Journal Entry</th><th>Account</th><th>Debit</th><th>Credit</th><th>Description</th></tr>
                        </thead>
                        <tbody>
                            @foreach (var jl in Model.JournalLines)
                            {
                                var je = Model.JournalEntries.FirstOrDefault(j => j.Id == jl.JournalEntryId);
                                var account = Model.Accounts.FirstOrDefault(a => a.Id == jl.AccountId);
                                <tr>
                                    <td>@(je?.JournalNumber ?? "-")</td>
                                    <td>@(account != null ? $"{account.AccountNumber}" : "-")</td>
                                    <td>@jl.Debit.ToString("C")</td>
                                    <td>@jl.Credit.ToString("C")</td>
                                    <td>@(string.IsNullOrWhiteSpace(jl.Description) ? "-" : jl.Description)</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== TAX RATES MODULE ========== -->
    <div class="card mb-3 financial-module" id="module-taxrates">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Tax Rates</h5>
            <button class="btn btn-sm btn-secondary toggle-btn" data-bs-toggle="collapse" data-bs-target="#taxratesCollapse" aria-expanded="false">Toggle</button>
        </div>
        <div id="taxratesCollapse" class="collapse" data-category-collapse="taxrates">
            <div class="card-body">
                <form method="post" class="row g-2 mb-3" asp-antiforgery="true">
                    <input type="hidden" asp-for="ActiveCategory" />
                    <input type="hidden" asp-for="FormType" value="taxrate" />
                    <div class="col-md-2">
                        <input asp-for="NewTaxCode" class="form-control" placeholder="Tax Code" required />
                    </div>
                    <div class="col-md-3">
                        <input asp-for="NewTaxDescription" class="form-control" placeholder="Description" required />
                    </div>
                    <div class="col-md-2">
                        <input asp-for="NewTaxPercentage" type="number" class="form-control" placeholder="Rate (0.08)" step="0.0001" required />
                    </div>
                    <div class="col-md-2">
                        <input asp-for="NewTaxType" class="form-control" placeholder="Type" />
                    </div>
                    <div class="col-md-2">
                        <input asp-for="NewTaxEffectiveDate" type="date" class="form-control" />
                    </div>
                    <div class="col-md-1 d-grid">
                        <button type="submit" class="btn btn-primary">Add</button>
                    </div>
                </form>
                <div class="table-responsive">
                    <table class="table table-sm table-striped mb-0">
                        <thead>
                            <tr><th>Code</th><th>Description</th><th>Rate</th><th>Type</th><th>Effective Date</th></tr>
                        </thead>
                        <tbody>
                            @foreach (var tr in Model.TaxRates)
                            {
                                <tr>
                                    <td>@tr.TaxCode</td>
                                    <td>@tr.TaxDescription</td>
                                    <td>@tr.Rate.ToString("P2")</td>
                                    <td>@(string.IsNullOrWhiteSpace(tr.TaxType) ? "-" : tr.TaxType)</td>
                                    <td>@tr.EffectiveDate.ToLocalTime().ToString("MM/dd/yyyy")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function(){
            const qs = new URLSearchParams(window.location.search);
            let active = (qs.get('ActiveCategory') || localStorage.getItem('financial_active_category') || '').toLowerCase();
            const valid = ['accounts','partners','invoices','openbalances','payments','journalentries','invoicelines','journallines','taxrates'];
            if(!valid.includes(active)) active = 'accounts';
            localStorage.setItem('financial_active_category', active);

            // Expand selected collapse
            const targetCollapse = document.querySelector(`[data-category-collapse="${active}"]`);
            if(targetCollapse){
                new bootstrap.Collapse(targetCollapse, { toggle: true });
            }

            // Highlight toolbar button
            document.querySelectorAll('[data-category]').forEach(btn => {
                if(btn.getAttribute('data-category') === active){
                    btn.classList.remove('btn-outline-primary');
                    btn.classList.add('btn-primary');
                } else {
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-outline-primary');
                }
            });

            // Clicking toolbar buttons navigates with query param
            document.querySelectorAll('[data-category]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const cat = btn.getAttribute('data-category');
                    if(!cat) return;
                    localStorage.setItem('financial_active_category', cat);
                    const url = new URL(window.location.href);
                    url.searchParams.set('ActiveCategory', cat);
                    window.location.href = url.toString();
                });
            });
        })();
    </script>
}
