@page
@model WebApplication1.Pages.CustomerRelationshipModel
@{
    ViewData["Title"] = "Customer Relationship";
}

<div class="container py-3">
    <h2 class="mb-4">Customer Relationship Management</h2>

    <!-- Top Metrics Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card border-primary shadow-sm crm-metric-card">
                <div class="card-body text-center">
                    <h6 class="card-title text-muted mb-2">Total Companies</h6>
                    <div class="metric-primary-value text-primary">@Model.TotalCompanies</div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-info shadow-sm crm-metric-card">
                <div class="card-body text-center">
                    <h6 class="card-title text-muted mb-2">Total Contacts</h6>
                    <div class="metric-primary-value text-info">@Model.TotalContacts</div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-success shadow-sm crm-metric-card top-opportunity-card">
                <div class="card-body text-center">
                    <h6 class="card-title text-muted mb-2">Top Opportunity</h6>
                    @if (Model.TopOpportunity != null)
                    {
                        <div class="metric-primary-value text-success top-op-value">@((Model.TopOpportunity.Value ?? 0).ToString("C"))</div>
                        <div class="metric-secondary-text text-success fw-semibold mt-2">@Model.TopOpportunity.Name</div>
                        <div class="metric-secondary-text text-muted">@Model.TopOpportunity.Company?.Name</div>
                    }
                    else
                    {
                        <div class="metric-primary-value text-muted top-op-value">–</div>
                        <div class="metric-secondary-text text-muted mt-2">No Opportunities</div>
                    }
                </div>
            </div>
        </div>
    </div>

    @if (!string.IsNullOrWhiteSpace(Model.ActiveModule) && ViewContext.ModelState.IsValid == false)
    {
        <div class="alert alert-danger py-2 mb-3">
            <strong>Validation failed.</strong>
            @if (Model.ValidationErrors?.Any() == true)
            {
                <ul class="mb-0 small">
                    @foreach (var err in Model.ValidationErrors)
                    {
                        <li>@err</li>
                    }
                </ul>
            }
            else
            {
                <span>Please check required fields.</span>
            }
        </div>
    }

    <!-- Top toolbar with module buttons removed as requested -->

    <!-- Companies Module -->
    <div class="card mb-3 crm-module" id="module-companies">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Companies</h5>
            <button class="btn btn-sm btn-secondary toggle-btn" data-bs-toggle="collapse" data-bs-target="#companiesCollapse" aria-expanded="false">Toggle</button>
        </div>
        <div id="companiesCollapse" class="collapse" data-module-collapse="companies">
            <div class="card-body">
                <form method="post" asp-page-handler="AddCompany" asp-antiforgery="true" class="row g-2 mb-3">
                    <div class="col-md-4">
                        <input asp-for="NewCompany.Name" class="form-control" placeholder="Name *" required />
                        <span asp-validation-for="NewCompany.Name" class="text-danger small"></span>
                    </div>
                    <div class="col-md-3">
                        <input asp-for="NewCompany.Industry" class="form-control" placeholder="Industry" />
                    </div>
                    <div class="col-md-3">
                        <input asp-for="NewCompany.Website" class="form-control" placeholder="Website" />
                    </div>
                    <div class="col-md-2 d-grid">
                        <button type="submit" class="btn btn-primary">Add</button>
                    </div>
                </form>
                <div class="table-responsive">
                    <table class="table table-sm table-striped mb-0">
                        <thead>
                            <tr>
                                <th>Name</th><th>Industry</th><th>Website</th><th>Created</th>
                                   <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var c in Model.Companies)
                            {
                                <tr>
                                    <td>@c.Name</td>
                                    <td>@(string.IsNullOrWhiteSpace(c.Industry)?"-":c.Industry)</td>
                                    <td>@(string.IsNullOrWhiteSpace(c.Website)?"-":c.Website)</td>
                                    <td>@c.CreatedAt.ToLocalTime().ToString("MM/dd/yyyy")</td>
                                       <td class="actions-cell">
                                           <div class="action-inline">
                                               <button type="button" class="btn btn-sm btn-warning" title="Edit Company" data-bs-toggle="modal" data-bs-target="#editCompanyModal"
                                                       data-id="@c.Id" data-name="@c.Name" data-industry="@c.Industry" data-website="@c.Website">
                                                   <i class="fas fa-edit"></i>
                                               </button>
                                               <form method="post" asp-page-handler="DeleteCompany" onsubmit="return confirm('Delete company @c.Name?');">
                                                   <input type="hidden" name="id" value="@c.Id" />
                                                   <button type="submit" class="btn btn-sm btn-danger" title="Delete Company"><i class="fas fa-trash"></i></button>
                                               </form>
                                           </div>
                                       </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Contacts Module -->
    <div class="card mb-3 crm-module" id="module-contacts">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Contacts</h5>
            <button class="btn btn-sm btn-secondary toggle-btn" data-bs-toggle="collapse" data-bs-target="#contactsCollapse" aria-expanded="false">Toggle</button>
        </div>
        <div id="contactsCollapse" class="collapse" data-module-collapse="contacts">
            <div class="card-body">
                <form method="post" asp-page-handler="AddContact" asp-antiforgery="true" class="row g-2 mb-3">
                    <div class="col-md-2">
                        <input asp-for="NewContact.FirstName" class="form-control" placeholder="First Name *" required />
                        <span asp-validation-for="NewContact.FirstName" class="text-danger small"></span>
                    </div>
                    <div class="col-md-2">
                        <input asp-for="NewContact.LastName" class="form-control" placeholder="Last Name *" required />
                        <span asp-validation-for="NewContact.LastName" class="text-danger small"></span>
                    </div>
                    <div class="col-md-2">
                        <input asp-for="NewContact.Email" class="form-control" placeholder="Email" />
                    </div>
                    <div class="col-md-2">
                        <input asp-for="NewContact.Phone" class="form-control" placeholder="Phone" />
                    </div>
                    <div class="col-md-3">
                        <input asp-for="NewContactCompanyName" class="form-control" placeholder="Company (optional – type to create or match)" />
                        <small class="text-muted">Leave blank or type a new/existing company name.</small>
                    </div>
                    <div class="col-md-1 d-grid">
                        <button type="submit" class="btn btn-primary">Add</button>
                    </div>
                </form>
                <div class="table-responsive">
                    <table class="table table-sm table-striped mb-0">
                        <thead>
                            <tr>
                                <th>Name</th><th>Email</th><th>Phone</th><th>Company</th><th>Created</th>
                                   <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var c in Model.Contacts)
                            {
                                <tr>
                                    <td>@c.FirstName @c.LastName</td>
                                    <td>@(string.IsNullOrWhiteSpace(c.Email)?"-":c.Email)</td>
                                    <td>@(string.IsNullOrWhiteSpace(c.Phone)?"-":c.Phone)</td>
                                    <td>@(c.Company?.Name ?? "-")</td>
                                    <td>@c.CreatedAt.ToLocalTime().ToString("MM/dd/yyyy")</td>
                                       <td class="actions-cell">
                                           <div class="action-inline">
                                               <button type="button" class="btn btn-sm btn-warning" title="Edit Contact" data-bs-toggle="modal" data-bs-target="#editContactModal"
                                                       data-id="@c.Id" data-first="@c.FirstName" data-last="@c.LastName" data-email="@c.Email" data-phone="@c.Phone" data-companyid="@c.CompanyId">
                                                   <i class="fas fa-edit"></i>
                                               </button>
                                               <form method="post" asp-page-handler="DeleteContact" onsubmit="return confirm('Delete contact @c.FirstName @c.LastName?');">
                                                   <input type="hidden" name="id" value="@c.Id" />
                                                   <button type="submit" class="btn btn-sm btn-danger" title="Delete Contact"><i class="fas fa-trash"></i></button>
                                               </form>
                                           </div>
                                       </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Opportunities Module -->
    <div class="card mb-3 crm-module" id="module-opportunities">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Opportunities</h5>
            <button class="btn btn-sm btn-secondary toggle-btn" data-bs-toggle="collapse" data-bs-target="#opportunitiesCollapse" aria-expanded="false">Toggle</button>
        </div>
        <div id="opportunitiesCollapse" class="collapse" data-module-collapse="opportunities">
            <div class="card-body">
                <form method="post" asp-page-handler="AddOpportunity" asp-antiforgery="true" class="row g-2 mb-3">
                    <div class="col-md-3">
                        <input asp-for="NewOpportunityCompanyName" class="form-control" placeholder="Company * (type to create or match)" required />
                        <small class="text-muted">Type a new or existing company name.</small>
                    </div>
                    <div class="col-md-3">
                        <input asp-for="NewOpportunity.Name" class="form-control" placeholder="Name *" required />
                        <span asp-validation-for="NewOpportunity.Name" class="text-danger small"></span>
                    </div>
                    <div class="col-md-2">
                        <input asp-for="NewOpportunity.Stage" class="form-control" placeholder="Stage" />
                    </div>
                    <div class="col-md-2">
                        <input asp-for="NewOpportunity.Value" type="number" class="form-control" placeholder="Value" step="0.01" />
                    </div>
                    <div class="col-md-1">
                        <input asp-for="NewOpportunity.CloseDate" type="date" class="form-control" />
                    </div>
                    <div class="col-md-1 d-grid">
                        <button type="submit" class="btn btn-primary">Add</button>
                    </div>
                </form>
                <div class="table-responsive">
                    <table class="table table-sm table-striped mb-0">
                        <thead>
                            <tr>
                                <th>Name</th><th>Stage</th><th>Value</th><th>Close Date</th><th>Company</th><th>Created</th>
                                   <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var o in Model.Opportunities)
                            {
                                <tr>
                                    <td>@o.Name</td>
                                    <td>@(string.IsNullOrWhiteSpace(o.Stage)?"-":o.Stage)</td>
                                    <td>@(o.Value?.ToString("C") ?? "-")</td>
                                    <td>@(o.CloseDate?.ToLocalTime().ToString("MM/dd/yyyy") ?? "-")</td>
                                    <td>@(o.Company?.Name ?? "-")</td>
                                    <td>@o.CreatedAt.ToLocalTime().ToString("MM/dd/yyyy")</td>
                                       <td class="actions-cell">
                                           <div class="action-inline">
                                               <button type="button" class="btn btn-sm btn-warning" title="Edit Opportunity" data-bs-toggle="modal" data-bs-target="#editOpportunityModal"
                                                       data-id="@o.Id" data-name="@o.Name" data-stage="@o.Stage" data-value="@o.Value" data-closedate="@o.CloseDate" data-companyid="@o.CompanyId">
                                                   <i class="fas fa-edit"></i>
                                               </button>
                                               <form method="post" asp-page-handler="DeleteOpportunity" onsubmit="return confirm('Delete opportunity @o.Name?');">
                                                   <input type="hidden" name="id" value="@o.Id" />
                                                   <button type="submit" class="btn btn-sm btn-danger" title="Delete Opportunity"><i class="fas fa-trash"></i></button>
                                               </form>
                                           </div>
                                       </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Activities Module (read only list for now) -->
    <div class="card mb-3 crm-module" id="module-activities">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Recent Activities</h5>
            <button class="btn btn-sm btn-secondary toggle-btn" data-bs-toggle="collapse" data-bs-target="#activitiesCollapse" aria-expanded="false">Toggle</button>
        </div>
        <div id="activitiesCollapse" class="collapse" data-module-collapse="activities">
            <div class="card-body">
                <form method="post" asp-page-handler="AddActivity" asp-antiforgery="true" class="row g-2 mb-3">
                    <div class="col-md-2">
                        <input asp-for="NewActivity.ActivityType" class="form-control" placeholder="Type (e.g. Call)" />
                    </div>
                    <div class="col-md-3">
                        <input asp-for="NewActivity.Subject" class="form-control" placeholder="Subject" />
                    </div>
                    <div class="col-md-2">
                        <input asp-for="NewActivity.ActivityDate" type="date" class="form-control" />
                    </div>
                    <div class="col-md-2">
                        <select asp-for="NewActivity.CompanyId" class="form-select">
                            <option value="">-- Optional Company --</option>
                            @foreach (var comp in Model.Companies)
                            {
                                <option value="@comp.Id">@comp.Name</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select asp-for="NewActivity.ContactId" class="form-select">
                            <option value="">-- Optional Contact --</option>
                            @foreach (var con in Model.Contacts)
                            {
                                <option value="@con.Id">@con.FirstName @con.LastName</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-1 d-grid">
                        <button type="submit" class="btn btn-primary">Add</button>
                    </div>
                </form>
                <div class="table-responsive">
                    <table class="table table-sm table-striped mb-0">
                        <thead>
                            <tr>
                                <th>Date</th><th>Type</th><th>Subject</th><th>Company</th><th>Contact</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var a in Model.Activities)
                            {
                                <tr>
                                    <td>@a.ActivityDate.ToLocalTime().ToString("MM/dd/yyyy")</td>
                                    <td>@(string.IsNullOrWhiteSpace(a.ActivityType)?"-":a.ActivityType)</td>
                                    <td>@(string.IsNullOrWhiteSpace(a.Subject)?"-":a.Subject)</td>
                                    <td>@(a.Company?.Name ?? "-")</td>
                                    <td>@((a.Contact != null) ? a.Contact.FirstName + " " + a.Contact.LastName : "-")</td>
                                       <td class="actions-cell">
                                           <div class="action-inline">
                                               <button type="button" class="btn btn-sm btn-warning" title="Edit Activity" data-bs-toggle="modal" data-bs-target="#editActivityModal"
                                                       data-id="@a.Id" data-type="@a.ActivityType" data-subject="@a.Subject" data-date="@a.ActivityDate" data-companyid="@a.CompanyId" data-contactid="@a.ContactId">
                                                   <i class="fas fa-edit"></i>
                                               </button>
                                               <form method="post" asp-page-handler="DeleteActivity" onsubmit="return confirm('Delete activity @a.ActivityType?');">
                                                   <input type="hidden" name="id" value="@a.Id" />
                                                   <button type="submit" class="btn btn-sm btn-danger" title="Delete Activity"><i class="fas fa-trash"></i></button>
                                               </form>
                                           </div>
                                       </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Notes Module (read only list for now) -->
    <div class="card mb-3 crm-module" id="module-notes">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Recent Notes</h5>
            <button class="btn btn-sm btn-secondary toggle-btn" data-bs-toggle="collapse" data-bs-target="#notesCollapse" aria-expanded="false">Toggle</button>
        </div>
        <div id="notesCollapse" class="collapse" data-module-collapse="notes">
            <div class="card-body">
                <form method="post" asp-page-handler="AddNote" asp-antiforgery="true" class="row g-2 mb-3">
                    <div class="col-md-5">
                        <textarea asp-for="NewNote.Content" class="form-control" rows="2" placeholder="Note Content *" required></textarea>
                        <span asp-validation-for="NewNote.Content" class="text-danger small"></span>
                    </div>
                    <div class="col-md-3">
                        <select asp-for="NewNote.CompanyId" class="form-select">
                            <option value="">-- Optional Company --</option>
                            @foreach (var comp in Model.Companies)
                            {
                                <option value="@comp.Id">@comp.Name</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select asp-for="NewNote.ContactId" class="form-select">
                            <option value="">-- Optional Contact --</option>
                            @foreach (var con in Model.Contacts)
                            {
                                <option value="@con.Id">@con.FirstName @con.LastName</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-1 d-grid">
                        <button type="submit" class="btn btn-primary">Add</button>
                    </div>
                </form>
                <div class="table-responsive">
                    <table class="table table-sm table-striped mb-0">
                        <thead>
                            <tr>
                                <th>Content</th><th>Company</th><th>Contact</th><th>Created</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var n in Model.Notes)
                            {
                                <tr>
                                    <td>@(n.Content.Length > 80 ? n.Content.Substring(0,80) + "..." : n.Content)</td>
                                    <td>@(n.Company?.Name ?? "-")</td>
                                    <td>@((n.Contact != null) ? n.Contact.FirstName + " " + n.Contact.LastName : "-")</td>
                                    <td>@n.CreatedAt.ToLocalTime().ToString("MM/dd/yyyy")</td>
                                       <td class="actions-cell">
                                           <div class="action-inline">
                                               <button type="button" class="btn btn-sm btn-warning" title="Edit Note" data-bs-toggle="modal" data-bs-target="#editNoteModal"
                                                       data-id="@n.Id" data-content="@n.Content" data-companyid="@n.CompanyId" data-contactid="@n.ContactId">
                                                   <i class="fas fa-edit"></i>
                                               </button>
                                               <form method="post" asp-page-handler="DeleteNote" onsubmit="return confirm('Delete note?');">
                                                   <input type="hidden" name="id" value="@n.Id" />
                                                   <button type="submit" class="btn btn-sm btn-danger" title="Delete Note"><i class="fas fa-trash"></i></button>
                                               </form>
                                           </div>
                                       </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function(){
            // Preserve ability to open with ?ActiveModule=... but default to Companies.
            const qs = new URLSearchParams(window.location.search);
            let active = (qs.get('ActiveModule') || localStorage.getItem('crm_active_module') || 'companies').toLowerCase();
            const valid = ['companies','contacts','opportunities','activities','notes'];
            if(!valid.includes(active)) active = 'companies';
            localStorage.setItem('crm_active_module', active);

            // Expand selected module collapse pane
            const targetCollapse = document.querySelector(`[data-module-collapse="${active}"]`);
            if(targetCollapse){
                new bootstrap.Collapse(targetCollapse, { toggle: true });
            }
                        // Populate edit modals (Bootstrap 5 events)
                        const hookup = (modalId, fields) => {
                            const modalEl = document.getElementById(modalId);
                            if(!modalEl) return;
                            modalEl.addEventListener('show.bs.modal', evt => {
                                const btn = evt.relatedTarget; if(!btn) return;
                                fields.forEach(f => {
                                    const el = document.getElementById(f.id);
                                    if(el){
                                        let val = btn.getAttribute(f.attr) || '';
                                        if(f.transform) val = f.transform(val);
                                        el.value = val;
                                    }
                                });
                            });
                        };
                        hookup('editCompanyModal', [
                            {id:'editCompanyId', attr:'data-id'},
                            {id:'editCompanyName', attr:'data-name'},
                            {id:'editCompanyIndustry', attr:'data-industry'},
                            {id:'editCompanyWebsite', attr:'data-website'}
                        ]);
                        hookup('editContactModal', [
                            {id:'editContactId', attr:'data-id'},
                            {id:'editContactFirst', attr:'data-first'},
                            {id:'editContactLast', attr:'data-last'},
                            {id:'editContactEmail', attr:'data-email'},
                            {id:'editContactPhone', attr:'data-phone'},
                            {id:'editContactCompany', attr:'data-companyid'}
                        ]);
                        hookup('editOpportunityModal', [
                            {id:'editOpportunityId', attr:'data-id'},
                            {id:'editOpportunityName', attr:'data-name'},
                            {id:'editOpportunityStage', attr:'data-stage'},
                            {id:'editOpportunityValue', attr:'data-value'},
                            {id:'editOpportunityCloseDate', attr:'data-closedate', transform:(v)=> v && v.includes('T')? v.split('T')[0]: v},
                            {id:'editOpportunityCompany', attr:'data-companyid'}
                        ]);
                        hookup('editActivityModal', [
                            {id:'editActivityId', attr:'data-id'},
                            {id:'editActivityType', attr:'data-type'},
                            {id:'editActivitySubject', attr:'data-subject'},
                            {id:'editActivityDate', attr:'data-date', transform:(v)=> v && v.includes('T')? v.split('T')[0]: v},
                            {id:'editActivityCompany', attr:'data-companyid'},
                            {id:'editActivityContact', attr:'data-contactid'}
                        ]);
                        hookup('editNoteModal', [
                            {id:'editNoteId', attr:'data-id'},
                            {id:'editNoteContent', attr:'data-content'},
                            {id:'editNoteCompany', attr:'data-companyid'},
                            {id:'editNoteContact', attr:'data-contactid'}
                        ]);
        })();
    </script>
}
